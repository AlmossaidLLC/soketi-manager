name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ghcr.io
  # Use lowercase org name for Docker compatibility
  IMAGE_NAME: ${{ github.repository_owner }}/soketi-manager

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed to write to create tags
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest version tag and increment
        id: version
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Get the latest version tag (matching pattern v*.* or *.*)
          LATEST_TAG=$(git tag -l --sort=-version:refname | grep -E '^v?[0-9]+\.[0-9]+$' | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            # No version tag found, start with 1.0
            NEW_VERSION="1.0"
            echo "No existing version tag found, starting with 1.0"
          else
            # Remove 'v' prefix if present
            VERSION_NUM=${LATEST_TAG#v}
            
            # Split version into major and minor
            MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
            MINOR=$(echo $VERSION_NUM | cut -d. -f2)
            
            # Increment minor by 0.2 (or 2 if stored as integer)
            NEW_MINOR=$((MINOR + 2))
            NEW_VERSION="${MAJOR}.${NEW_MINOR}"
            
            echo "Latest version tag: $LATEST_TAG"
            echo "New version: $NEW_VERSION"
          fi
          
          # Set output
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=v$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Display the new version
          echo "üöÄ New version tag will be: v$NEW_VERSION"

      - name: Create and push version tag
        run: |
          VERSION_TAG="${{ steps.version.outputs.VERSION_TAG }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION_TAG" -m "Release version $VERSION_TAG"
          git push origin "$VERSION_TAG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract metadata (for tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.version.outputs.VERSION_TAG }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "‚úÖ Docker image built and pushed successfully"
          echo "üì¶ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "üè∑Ô∏è  Version Tag: ${{ steps.version.outputs.VERSION_TAG }}"
          echo "üè∑Ô∏è  All Tags: ${{ steps.meta.outputs.tags }}"
